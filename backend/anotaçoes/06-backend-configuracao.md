# ‚öôÔ∏è Fase 6: Configura√ß√£o do Backend Node.js

Agora vamos configurar o servidor Express.js e a conex√£o com o banco de dados PostgreSQL.

## üìã Pr√©-requisitos

- ‚úÖ Node.js instalado
- ‚úÖ Depend√™ncias instaladas (express, pg, cors, dotenv)
- ‚úÖ Banco de dados configurado com dados de teste
- ‚úÖ Arquivo `.env` configurado

## üèóÔ∏è Estrutura do Backend

Vamos criar a seguinte estrutura:

```
backend/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.js          # Configura√ß√£o do banco
‚îú‚îÄ‚îÄ server.js                # Servidor principal
‚îú‚îÄ‚îÄ package.json             # Depend√™ncias
‚îî‚îÄ‚îÄ .env                     # Vari√°veis de ambiente
```

---

## üìù Passo 1: Criar Configura√ß√£o do Banco

### **1.1 Criar arquivo config/database.js**
Crie o arquivo `config/database.js` com o seguinte conte√∫do:

```javascript
// ============================================
// VoltWay - Configura√ß√£o do Banco de Dados
// ============================================

require('dotenv').config();
const { Pool } = require('pg');

// Configura√ß√£o da conex√£o com PostgreSQL
const pool = new Pool({
  user: process.env.DB_USER || 'voltway_user',
  host: process.env.DB_HOST || 'localhost',
  database: process.env.DB_NAME || 'voltway',
  password: process.env.DB_PASSWORD || 'voltway123',
  port: process.env.DB_PORT || 5432,
  
  // Configura√ß√µes de conex√£o
  max: 20, // M√°ximo de conex√µes no pool
  idleTimeoutMillis: 30000, // Tempo limite para conex√µes ociosas
  connectionTimeoutMillis: 2000, // Tempo limite para estabelecer conex√£o
});

// Evento de conex√£o bem-sucedida
pool.on('connect', () => {
  console.log('‚úÖ Conectado ao banco de dados PostgreSQL');
});

// Evento de erro na conex√£o
pool.on('error', (err) => {
  console.error('‚ùå Erro na conex√£o com o banco de dados:', err);
  process.exit(-1);
});

// Fun√ß√£o para testar a conex√£o
const testConnection = async () => {
  try {
    const client = await pool.connect();
    const result = await client.query('SELECT NOW() as current_time, version() as postgres_version');
    console.log('üîç Teste de conex√£o realizado:', result.rows[0].current_time);
    console.log('üìä Vers√£o do PostgreSQL:', result.rows[0].postgres_version.split(' ')[0]);
    client.release();
    return true;
  } catch (err) {
    console.error('‚ùå Falha no teste de conex√£o:', err.message);
    return false;
  }
};

// Fun√ß√£o para executar queries com tratamento de erro
const query = async (text, params) => {
  const start = Date.now();
  try {
    const res = await pool.query(text, params);
    const duration = Date.now() - start;
    console.log('üìù Query executada:', { text, duration, rows: res.rowCount });
    return res;
  } catch (err) {
    console.error('‚ùå Erro na query:', { text, error: err.message });
    throw err;
  }
};

// Fun√ß√£o para executar transa√ß√µes
const transaction = async (callback) => {
  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const result = await callback(client);
    await client.query('COMMIT');
    return result;
  } catch (err) {
    await client.query('ROLLBACK');
    throw err;
  } finally {
    client.release();
  }
};

// Fun√ß√£o para verificar se as tabelas existem
const checkTables = async () => {
  try {
    const result = await query(`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_type = 'BASE TABLE'
      ORDER BY table_name;
    `);
    
    const tables = result.rows.map(row => row.table_name);
    const expectedTables = ['usuarios', 'veiculos', 'estacoes', 'reservas'];
    const missingTables = expectedTables.filter(table => !tables.includes(table));
    
    if (missingTables.length > 0) {
      console.warn('‚ö†Ô∏è  Tabelas n√£o encontradas:', missingTables);
      console.log('üí° Execute o script schema.sql para criar as tabelas');
      return false;
    } else {
      console.log('‚úÖ Todas as tabelas est√£o presentes:', tables);
      return true;
    }
  } catch (err) {
    console.error('‚ùå Erro ao verificar tabelas:', err.message);
    return false;
  }
};

// Fun√ß√£o para obter estat√≠sticas do banco
const getStats = async () => {
  try {
    const stats = await query(`
      SELECT 
        'usuarios' as tabela, COUNT(*) as registros FROM usuarios
      UNION ALL
      SELECT 
        'veiculos' as tabela, COUNT(*) as registros FROM veiculos
      UNION ALL
      SELECT 
        'estacoes' as tabela, COUNT(*) as registros FROM estacoes
      UNION ALL
      SELECT 
        'reservas' as tabela, COUNT(*) as registros FROM reservas
      ORDER BY tabela;
    `);
    
    console.log('üìä Estat√≠sticas do banco:');
    stats.rows.forEach(row => {
      console.log(`   ${row.tabela}: ${row.registros} registros`);
    });
    
    return stats.rows;
  } catch (err) {
    console.error('‚ùå Erro ao obter estat√≠sticas:', err.message);
    return [];
  }
};

// Fun√ß√£o para fechar todas as conex√µes
const closePool = async () => {
  try {
    await pool.end();
    console.log('üîå Pool de conex√µes fechado');
  } catch (err) {
    console.error('‚ùå Erro ao fechar pool:', err.message);
  }
};

module.exports = {
  pool,
  query,
  transaction,
  testConnection,
  checkTables,
  getStats,
  closePool
};
```

---

## üöÄ Passo 2: Criar Servidor Principal

### **2.1 Criar arquivo server.js**
Crie o arquivo `server.js` na raiz da pasta backend:

```javascript
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const path = require('path');

// Importar configura√ß√£o do banco
const db = require('./config/database');

const app = express();

// Middlewares
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, '../')));

// Middleware de logging
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});

// ============================================
// ROTAS DA API
// ============================================

// Rota de teste
app.get('/', (req, res) => {
  res.json({
    message: 'VoltWay API est√° rodando!',
    version: '1.0.0',
    timestamp: new Date().toISOString()
  });
});

// Rota de health check
app.get('/api/health', async (req, res) => {
  try {
    const dbConnected = await db.testConnection();
    const stats = await db.getStats();
    
    res.json({
      success: true,
      status: 'healthy',
      database: dbConnected ? 'connected' : 'disconnected',
      timestamp: new Date().toISOString(),
      stats: stats
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      status: 'unhealthy',
      error: error.message
    });
  }
});

// ============================================
// ROTAS DE USU√ÅRIOS
// ============================================

// GET /api/usuarios - Listar usu√°rios
app.get('/api/usuarios', async (req, res) => {
  try {
    const { tipo, cidade, estado, limit = 50, offset = 0 } = req.query;
    
    let query = 'SELECT id, nome, email, tipo, cidade, estado, criado_em FROM usuarios WHERE 1=1';
    const params = [];
    let paramCount = 0;
    
    if (tipo) {
      paramCount++;
      query += ` AND tipo = $${paramCount}`;
      params.push(tipo);
    }
    
    if (cidade) {
      paramCount++;
      query += ` AND cidade ILIKE $${paramCount}`;
      params.push(`%${cidade}%`);
    }
    
    if (estado) {
      paramCount++;
      query += ` AND estado ILIKE $${paramCount}`;
      params.push(`%${estado}%`);
    }
    
    query += ` ORDER BY criado_em DESC LIMIT $${paramCount + 1} OFFSET $${paramCount + 2}`;
    params.push(limit, offset);
    
    const result = await db.query(query, params);
    
    res.json({
      success: true,
      data: result.rows,
      total: result.rowCount,
      limit: parseInt(limit),
      offset: parseInt(offset)
    });
  } catch (error) {
    console.error('Erro ao buscar usu√°rios:', error);
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor'
    });
  }
});

// GET /api/usuarios/:id - Buscar usu√°rio por ID
app.get('/api/usuarios/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const result = await db.query(
      'SELECT id, nome, email, tipo, cidade, estado, criado_em FROM usuarios WHERE id = $1',
      [id]
    );
    
    if (result.rows.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'Usu√°rio n√£o encontrado'
      });
    }
    
    res.json({
      success: true,
      data: result.rows[0]
    });
  } catch (error) {
    console.error('Erro ao buscar usu√°rio:', error);
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor'
    });
  }
});

// POST /api/usuarios - Criar usu√°rio
app.post('/api/usuarios', async (req, res) => {
  try {
    const { nome, email, tipo = 'usuario', senha, cidade, estado } = req.body;
    
    // Valida√ß√µes b√°sicas
    if (!nome || !email) {
      return res.status(400).json({
        success: false,
        error: 'Nome e email s√£o obrigat√≥rios'
      });
    }
    
    const result = await db.query(
      `INSERT INTO usuarios (nome, email, tipo, senha, cidade, estado) 
       VALUES ($1, $2, $3, $4, $5, $6) 
       RETURNING id, nome, email, tipo, cidade, estado, criado_em`,
      [nome, email, tipo, senha, cidade, estado]
    );
    
    res.status(201).json({
      success: true,
      message: 'Usu√°rio criado com sucesso',
      data: result.rows[0]
    });
  } catch (error) {
    console.error('Erro ao criar usu√°rio:', error);
    if (error.code === '23505') { // Unique violation
      res.status(409).json({
        success: false,
        error: 'Email j√° est√° em uso'
      });
    } else {
      res.status(500).json({
        success: false,
        error: 'Erro interno do servidor'
      });
    }
  }
});

// ============================================
// MIDDLEWARE DE ERRO 404
// ============================================
app.use((req, res) => {
  res.status(404).json({
    success: false,
    error: 'Endpoint n√£o encontrado',
    path: req.path,
    method: req.method
  });
});

// ============================================
// INICIALIZA√á√ÉO DO SERVIDOR
// ============================================
const PORT = process.env.PORT || 3000;

const startServer = async () => {
  try {
    // Testar conex√£o com o banco
    const dbConnected = await db.testConnection();
    if (!dbConnected) {
      console.error('‚ùå Falha na conex√£o com o banco de dados');
      process.exit(1);
    }
    
    // Verificar se as tabelas existem
    const tablesExist = await db.checkTables();
    if (!tablesExist) {
      console.warn('‚ö†Ô∏è  Algumas tabelas podem estar faltando');
    }
    
    // Mostrar estat√≠sticas do banco
    await db.getStats();
    
    // Iniciar servidor
    app.listen(PORT, () => {
      console.log(`üöÄ Servidor VoltWay rodando na porta ${PORT}`);
      console.log(`üìä API dispon√≠vel em: http://localhost:${PORT}`);
      console.log(`üè• Health check: http://localhost:${PORT}/api/health`);
      console.log(`üìö Documenta√ß√£o: docs/API.md`);
    });
    
  } catch (error) {
    console.error('‚ùå Erro ao iniciar servidor:', error);
    process.exit(1);
  }
};

// Tratamento de sinais para encerramento gracioso
process.on('SIGINT', async () => {
  console.log('\nüõë Encerrando servidor...');
  await db.closePool();
  process.exit(0);
});

process.on('SIGTERM', async () => {
  console.log('\nüõë Encerrando servidor...');
  await db.closePool();
  process.exit(0);
});

// Iniciar servidor
startServer();
```

---

## üß™ Passo 3: Testar o Servidor

### **3.1 Iniciar o servidor**
```bash
# Iniciar o servidor
npm start
```

**Resultado esperado:**
```
‚úÖ Conectado ao banco de dados PostgreSQL
üîç Teste de conex√£o realizado: 2024-09-29T10:30:00.000Z
üìä Vers√£o do PostgreSQL: PostgreSQL
‚úÖ Todas as tabelas est√£o presentes: [ 'estacoes', 'reservas', 'usuarios', 'veiculos' ]
üìä Estat√≠sticas do banco:
   estacoes: 11 registros
   reservas: 12 registros
   usuarios: 8 registros
   veiculos: 7 registros
üöÄ Servidor VoltWay rodando na porta 3000
üìä API dispon√≠vel em: http://localhost:3000
üè• Health check: http://localhost:3000/api/health
```

### **3.2 Testar endpoints**
```bash
# Testar rota principal (em outro terminal)
curl http://localhost:3000
```

**Resultado esperado:**
```json
{
  "message": "VoltWay API est√° rodando!",
  "version": "1.0.0",
  "timestamp": "2024-09-29T10:30:00.000Z"
}
```

### **3.3 Testar health check**
```bash
# Testar health check
curl http://localhost:3000/api/health
```

**Resultado esperado:**
```json
{
  "success": true,
  "status": "healthy",
  "database": "connected",
  "timestamp": "2024-09-29T10:30:00.000Z",
  "stats": [
    { "tabela": "estacoes", "registros": "11" },
    { "tabela": "reservas", "registros": "12" },
    { "tabela": "usuarios", "registros": "8" },
    { "tabela": "veiculos", "registros": "7" }
  ]
}
```

### **3.4 Testar endpoint de usu√°rios**
```bash
# Listar usu√°rios
curl http://localhost:3000/api/usuarios
```

**Resultado esperado:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "nome": "Jo√£o Silva",
      "email": "joao.silva@email.com",
      "tipo": "usuario",
      "cidade": "S√£o Paulo",
      "estado": "SP",
      "criado_em": "2024-09-29T10:30:00.000Z"
    },
    ...
  ],
  "total": 8,
  "limit": 50,
  "offset": 0
}
```

---

## üîß Passo 4: Configurar Scripts de Desenvolvimento

### **4.1 Adicionar script de desenvolvimento**
No `package.json`, adicione:

```json
{
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  }
}
```

### **4.2 Testar modo desenvolvimento**
```bash
# Iniciar em modo desenvolvimento (com auto-reload)
npm run dev
```

---

## ‚úÖ Verifica√ß√£o Final

### **Checklist de Funcionamento:**
- [ ] Servidor inicia sem erros
- [ ] Conex√£o com banco estabelecida
- [ ] Health check retorna status "healthy"
- [ ] Endpoint de usu√°rios retorna dados
- [ ] Logs aparecem no console
- [ ] Servidor responde na porta 3000

### **Teste de Performance:**
```bash
# Testar m√∫ltiplas requisi√ß√µes
for i in {1..5}; do curl -s http://localhost:3000/api/health | jq .status; done
```

---

## üö® Problemas Comuns

### **Erro: "Cannot find module './config/database'"**
```bash
# Solu√ß√£o: Verificar se o arquivo existe
ls -la config/database.js
```

### **Erro: "ECONNREFUSED"**
```bash
# Solu√ß√£o: Verificar se PostgreSQL est√° rodando
Get-Service | Where-Object {$_.Name -like "*postgres*"}
```

### **Erro: "authentication failed"**
```bash
# Solu√ß√£o: Verificar credenciais no .env
cat .env | grep DB_
```

### **Erro: "port 3000 already in use"**
```bash
# Solu√ß√£o: Mudar porta ou matar processo
netstat -ano | findstr :3000
taskkill /PID <PID> /F
```

---

## üéØ Pr√≥ximo Passo

Ap√≥s completar a configura√ß√£o do backend, prossiga para:
**[07-backend-conexao-db.md](./07-backend-conexao-db.md)** - Detalhes da conex√£o com banco

---

**Tempo estimado:** 20-30 minutos  
**Dificuldade:** Intermedi√°rio  
**Pr√≥ximo:** Detalhes da conex√£o com banco
